const express = require('express');
const cors = require('cors');
const swaggerJSDoc = require('swagger-jsdoc');
const { apiReference } = require('@scalar/api-reference');

const app = express();
const port = process.env.PORT || 10000;

// Middlewares
app.use(cors());
app.use(express.json());

// Configura√ß√£o do Swagger/OpenAPI
const swaggerOptions = {
  definition: {
    openapi: '3.0.3',
    info: {
      title: 'üöÄ Zionic API',
      version: '3.0.0',
      description: `
# üì± API Zionic - WhatsApp Business Integra√ß√£o

**Plataforma completa para automa√ß√£o de WhatsApp Business**

## üåü **Vis√£o Geral**

A API Zionic oferece integra√ß√£o robusta com WhatsApp Business, permitindo envio de mensagens, m√≠dia e automa√ß√£o completa de conversas.

## üìã **Recursos Dispon√≠veis**

### üîê **Autentica√ß√£o**
- ‚úÖ Teste de API Key - \`GET /api/auth/test\`

### üìû **Mensagens por N√∫mero**
- ‚úÖ Envio de texto - \`POST /api/messages/send\`
- ‚úÖ Envio de m√≠dia com upload - \`POST /api/messages/send-media\` 
- ‚úÖ Resposta com cita√ß√£o - \`POST /api/messages/reply\`

### üì± **Mensagens via URL**
- ‚úÖ Envio de texto - \`POST /api/conversation/send-text\`
- ‚úÖ Envio de imagem via URL - \`POST /api/conversation/send-image\`
- ‚úÖ Envio de √°udio via URL - \`POST /api/conversation/send-audio\`
- ‚úÖ Envio de v√≠deo via URL - \`POST /api/conversation/send-video\`
- ‚úÖ Envio de documento via URL - \`POST /api/conversation/send-document\`
- ‚úÖ Marcar como lida - \`POST /api/conversation/mark-read\`
- ‚úÖ Obter dados da conversa - \`GET /api/conversation/:conversation_id\`

### üì§ **Upload Direto de Arquivos**
- ‚úÖ Upload de imagem - \`POST /api/conversation/upload-image\`
- ‚úÖ Upload de √°udio - \`POST /api/conversation/upload-audio\`
- ‚úÖ Upload de v√≠deo - \`POST /api/conversation/upload-video\`
- ‚úÖ Upload de documento - \`POST /api/conversation/upload-document\`

## üîë **Autentica√ß√£o**

Todas as rotas requerem autentica√ß√£o via **Bearer Token**:

\`\`\`
Authorization: Bearer zio_sua_api_key_aqui
\`\`\`

## üöÄ **Base URL**

\`\`\`
https://api.zionic.com
\`\`\`

## üìû **Suporte**

- **Website:** https://zionic.com
- **Email:** suporte@zionic.com
- **Documenta√ß√£o:** https://docs.zionic.com
      `,
      contact: {
        name: 'Zionic Support',
        url: 'https://zionic.com',
        email: 'suporte@zionic.com'
      },
      license: {
        name: 'MIT',
        url: 'https://opensource.org/licenses/MIT'
      }
    },
    servers: [
      {
        url: 'https://api.zionic.com',
        description: 'Servidor de Produ√ß√£o'
      },
      {
        url: 'http://localhost:3001',
        description: 'Servidor de Desenvolvimento'
      }
    ],
    components: {
      securitySchemes: {
        BearerAuth: {
          type: 'http',
          scheme: 'bearer',
          bearerFormat: 'JWT',
          description: 'Insira sua API Key no formato: zio_sua_key_aqui'
        }
      }
    },
    security: [
      {
        BearerAuth: []
      }
    ]
  },
  apis: ['./index.js'] // Aponta para este arquivo
};

const swaggerSpec = swaggerJSDoc(swaggerOptions);

// Configura√ß√£o do Scalar com tema customizado
const scalarConfig = {
  theme: 'purple',
  customCss: `
    :root {
      --scalar-background-1: #0f172a;
      --scalar-background-2: #1e293b;
      --scalar-background-3: #334155;
      --scalar-color-1: #f1f5f9;
      --scalar-color-2: #cbd5e1;
      --scalar-color-3: #94a3b8;
      --scalar-accent: #3b82f6;
      --scalar-border-color: #475569;
    }
    
    .scalar-app {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    .scalar-api-reference {
      --scalar-radius: 8px;
      --scalar-radius-lg: 12px;
    }
  `,
  searchHotKey: 'k',
  showSidebar: true,
  hideDownloadButton: false,
  hideTestRequestButton: false,
  hiddenClients: [],
  layout: 'modern'
};

// Rota principal para documenta√ß√£o com Scalar
app.get('/', (req, res) => {
  const html = apiReference({
    spec: {
      content: swaggerSpec,
    },
    configuration: scalarConfig,
  });
  
  res.setHeader('Content-Type', 'text/html');
  res.send(html);
});

// Rota para a documenta√ß√£o expl√≠cita
app.get('/docs', (req, res) => {
  const html = apiReference({
    spec: {
      content: swaggerSpec,
    },
    configuration: scalarConfig,
  });
  
  res.setHeader('Content-Type', 'text/html');
  res.send(html);
});

// Health check
app.get('/health', (req, res) => {
  res.json({ 
    status: 'OK', 
    service: 'Zionic API Documentation',
    version: '3.0.0',
    timestamp: new Date().toISOString(),
    ui: 'Scalar API Reference'
  });
});

/**
 * @swagger
 * /api/auth/test:
 *   get:
 *     summary: üîê Testar API Key
 *     description: Verifica se a API Key fornecida √© v√°lida e retorna informa√ß√µes sobre a empresa e chave
 *     tags:
 *       - üîê Autentica√ß√£o
 *     security:
 *       - BearerAuth: []
 *     responses:
 *       200:
 *         description: API Key v√°lida
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 message:
 *                   type: string
 *                   example: "Autentica√ß√£o bem-sucedida!"
 *                 company:
 *                   type: object
 *                   properties:
 *                     id:
 *                       type: string
 *                       description: ID da empresa
 *                     name:
 *                       type: string
 *                       description: Nome da empresa
 *                 apiKey:
 *                   type: object
 *                   properties:
 *                     name:
 *                       type: string
 *                       description: Nome da API Key
 *                     created_at:
 *                       type: string
 *                       format: date-time
 *                       description: Data de cria√ß√£o
 *                     last_used_at:
 *                       type: string
 *                       format: date-time
 *                       description: √öltimo uso
 *       401:
 *         description: API Key inv√°lida ou inativa
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 error:
 *                   type: string
 *                   example: "API Key inv√°lida ou inativa"
 *                 message:
 *                   type: string
 *                   example: "Verifique se a API Key est√° correta e ativa"
 */

/**
 * @swagger
 * /api/messages/send:
 *   post:
 *     summary: üì± Enviar Mensagem de Texto por N√∫mero
 *     description: Envia uma mensagem de texto diretamente para um n√∫mero de telefone, criando automaticamente contato e conversa se necess√°rio
 *     tags:
 *       - üìû Mensagens por N√∫mero
 *     security:
 *       - BearerAuth: []
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - number
 *               - message
 *             properties:
 *               number:
 *                 type: string
 *                 description: N√∫mero de telefone do destinat√°rio (formato internacional)
 *                 example: "5511999999999"
 *                 pattern: "^[0-9]{10,15}$"
 *               message:
 *                 type: string
 *                 description: Texto da mensagem a ser enviada
 *                 example: "Ol√°! Como posso ajud√°-lo hoje?"
 *                 maxLength: 4096
 *               instance_id:
 *                 type: string
 *                 format: uuid
 *                 description: ID espec√≠fico da inst√¢ncia WhatsApp (opcional)
 *                 example: "uuid-da-instancia"
 *               instance_name:
 *                 type: string
 *                 description: Nome espec√≠fico da inst√¢ncia WhatsApp (opcional)
 *                 example: "vendas-sp"
 *     responses:
 *       200:
 *         description: Mensagem enviada com sucesso
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                   example: true
 *                 message:
 *                   type: string
 *                   example: "Mensagem enviada com sucesso"
 *                 data:
 *                   type: object
 *                   properties:
 *                     messageId:
 *                       type: string
 *                       description: ID da mensagem no banco de dados
 *                     conversationId:
 *                       type: string
 *                       description: ID da conversa
 *                     contactId:
 *                       type: string
 *                       description: ID do contato
 *                     instanceName:
 *                       type: string
 *                       description: Nome da inst√¢ncia WhatsApp
 *                     evolutionId:
 *                       type: string
 *                       description: ID da mensagem no WhatsApp
 *                     isNewContact:
 *                       type: boolean
 *                       description: Se √© um novo contato criado
 *                     isNewConversation:
 *                       type: boolean
 *                       description: Se √© uma nova conversa criada
 *                     number:
 *                       type: string
 *                       description: N√∫mero limpo usado
 *                     content:
 *                       type: string
 *                       description: Conte√∫do da mensagem enviada
 *                     sentAt:
 *                       type: string
 *                       format: date-time
 *                       description: Timestamp do envio
 *       400:
 *         description: N√∫mero inv√°lido ou par√¢metros incorretos
 *       404:
 *         description: Inst√¢ncia WhatsApp n√£o encontrada ou desconectada
 */

/**
 * @swagger
 * /api/messages/send-media:
 *   post:
 *     summary: üìé Enviar M√≠dia por N√∫mero
 *     description: Envia um arquivo de m√≠dia (imagem, v√≠deo, √°udio ou documento) para um n√∫mero de telefone
 *     tags:
 *       - üìû Mensagens por N√∫mero
 *     security:
 *       - BearerAuth: []
 *     requestBody:
 *       required: true
 *       content:
 *         multipart/form-data:
 *           schema:
 *             type: object
 *             required:
 *               - number
 *               - file
 *             properties:
 *               number:
 *                 type: string
 *                 description: N√∫mero de telefone do destinat√°rio
 *                 example: "5511999999999"
 *               file:
 *                 type: string
 *                 format: binary
 *                 description: Arquivo de m√≠dia para envio
 *               caption:
 *                 type: string
 *                 description: Legenda do arquivo (opcional)
 *                 example: "Arquivo importante!"
 *               instance_id:
 *                 type: string
 *                 format: uuid
 *                 description: ID espec√≠fico da inst√¢ncia WhatsApp (opcional)
 *               instance_name:
 *                 type: string
 *                 description: Nome espec√≠fico da inst√¢ncia WhatsApp (opcional)
 *                 example: "vendas-sp"
 *     responses:
 *       200:
 *         description: M√≠dia enviada com sucesso
 *       400:
 *         description: Arquivo ou par√¢metros inv√°lidos
 *       404:
 *         description: Inst√¢ncia WhatsApp n√£o encontrada
 */

/**
 * @swagger
 * /api/messages/reply:
 *   post:
 *     summary: üí¨ Responder Mensagem Espec√≠fica
 *     description: Responde uma mensagem espec√≠fica citando-a (reply/quote), criando uma resposta linkada √† mensagem original
 *     tags:
 *       - üìû Mensagens por N√∫mero
 *     security:
 *       - BearerAuth: []
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - number
 *               - message
 *               - quotedMessageId
 *             properties:
 *               number:
 *                 type: string
 *                 description: N√∫mero de telefone do destinat√°rio
 *                 example: "5511999999999"
 *               message:
 *                 type: string
 *                 description: Texto da resposta
 *                 example: "Obrigado pela sua mensagem!"
 *               quotedMessageId:
 *                 type: string
 *                 description: ID da mensagem original que est√° sendo respondida
 *                 example: "uuid-da-mensagem-original"
 *               instance_id:
 *                 type: string
 *                 format: uuid
 *                 description: ID espec√≠fico da inst√¢ncia WhatsApp (opcional)
 *               instance_name:
 *                 type: string
 *                 description: Nome espec√≠fico da inst√¢ncia WhatsApp (opcional)
 *                 example: "vendas-sp"
 *     responses:
 *       200:
 *         description: Resposta enviada com sucesso
 *       400:
 *         description: Par√¢metros inv√°lidos ou mensagem original n√£o encontrada
 *       404:
 *         description: Inst√¢ncia WhatsApp ou mensagem original n√£o encontrada
 */

app.listen(port, () => {
  console.log(`üöÄ Zionic API Docs (Scalar) rodando na porta ${port}`);
  console.log(`üìö Documenta√ß√£o moderna: http://localhost:${port}`);
  console.log(`üé® Interface: Scalar API Reference`);
}); 
